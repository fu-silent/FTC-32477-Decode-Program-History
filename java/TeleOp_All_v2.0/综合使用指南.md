# 📚 v2.0 综合使用指南

> **修改代码前务必阅读项目根目录的 `修改指南.md`！**

## ⚙️ 快速配置

### 1. 修改硬件名称

**文件位置**：
- 单文件版：TeleOp_All_2_0_0.java 中的 Constants 类
- 多文件版：RobotConstants_2_0.java

**需要修改的硬件**
```java
// 底盘（与 v1.0 相同）
CHASSIS_MOTOR_FRONT_LEFT_NAME = "lf";
CHASSIS_MOTOR_FRONT_RIGHT_NAME = "rf";
CHASSIS_MOTOR_BACK_LEFT_NAME = "lb";
CHASSIS_MOTOR_BACK_RIGHT_NAME = "rb";

// 子系统（v2.0 新增 IMU 和第二个发射电机）
SUBSYSTEM_INTAKE_MOTOR_NAME = "intake";
SUBSYSTEM_LOAD_MOTOR_NAME = "load";
SUBSYSTEM_SHOOTER1_MOTOR_NAME = "s1";      // 第一个发射电机
SUBSYSTEM_SHOOTER2_MOTOR_NAME = "s2";      // 第二个发射电机
IMU_SENSOR_NAME = "imu";                   // IMU 传感器
```

### 2. 修改转速档位

```java
// 4 个转速档位，根据场地调整
SHOOTER_RPM_LONG_RANGE = 3200;      // D-Pad 右：超远距离
SHOOTER_RPM_TRIANGLE_SIDE = 1900;   // D-Pad 左：三角腰部
SHOOTER_RPM_TRIANGLE_BASE = 1650;   // D-Pad 下：三角底部
SHOOTER_RPM_TRIANGLE_TOP = 2400;    // D-Pad 上：三角顶点
```

### 3. 修改精度范围

```java
// 每个档位的精度要求不同
SHOOTER_RPM_ERROR_RANGE_LONG = 30;      // 超远：±30 RPM（精度高）
SHOOTER_RPM_ERROR_RANGE_SIDE = 50;      // 腰部：±50 RPM
SHOOTER_RPM_ERROR_RANGE_BASE = 150;     // 底部：±150 RPM（精度低）
SHOOTER_RPM_ERROR_RANGE_TOP = 35;       // 顶点：±35 RPM（精度高）
```

### 4. 修改 IMU 自动转向参数

```java
AUTO_TURN_TARGET_RIGHT = 45.0;          // 右肩键转向角度

// PID 参数（控制转向平稳性）
AUTO_TURN_P_GAIN = 0.1;                 // 比例项（控制快速响应）
AUTO_TURN_I_GAIN = 0.0;                 // 积分项（消除误差）
AUTO_TURN_D_GAIN = 0.005;               // 微分项（防止超调）

AUTO_TURN_HEADING_THRESHOLD = 2.0;      // 到达目标的精度（±2°）
```

---

## 🎮 完整按键参考

| 分类 | 按键 | 功能 | 说明 |
|------|------|------|------|
| **底盘** | 左摇杆↑↓ | 前后移动 | 向上前进、向下后退 |
| | 左摇杆← → | 左右平移 | 平行移动 |
| | 右摇杆← → | 原地旋转 | 灵敏度 80% |
| | 右肩键 | 自动转向 | **【新】** 自动向右转45° |
| **拾取** | A 键 | 拾取进 | 启动拾取电机 |
| | B 键 | 拾取退 | 拾取反向 + 装填反向 |
| | X 键 | 停止 | 停止所有子系统 |
| **发射** | D-Pad → | 超远档 | 3200 RPM，精度 ±30 |
| | D-Pad ← | 腰部档 | 1900 RPM，精度 ±50 |
| | D-Pad ↓ | 底部档 | 1650 RPM，精度 ±150 |
| | D-Pad ↑ | 顶点档 | 2400 RPM，精度 ±35 |
| | Y 键 | 发射/停止 | 转速达标时启动，再按停止 |

---

## 🔧 常见问题和解决方案

### Q1: IMU 读数异常或不准确

**症状**：
- 显示的航向角度不合理
- 自动转向抖动或转不准

**解决方案**：
1. 确保 IMU 已连接到控制器
2. 上传程序后，让机器人平放静止 2-3 秒
3. 如果仍不准，在代码中调用 `navigation.initialize()` 重新初始化
4. 可以在遥测中观察航向值，确保在 -180° 到 180° 范围内

### Q2: 自动转向速度太快或太慢

**调整 PID 参数**：

```java
// 转向太慢 → 增加 P 值
AUTO_TURN_P_GAIN = 0.15;  // 从 0.1 增加到 0.15

// 转向超调（冲过头）→ 增加 D 值
AUTO_TURN_D_GAIN = 0.01;  // 从 0.005 增加到 0.01

// 精度不够 → 减小 HEADING_THRESHOLD
AUTO_TURN_HEADING_THRESHOLD = 1.0;  // 从 2.0 改为 1.0
```

### Q3: 双发射电机转速不同步

**症状**：
- 两个电机转速差异大
- 射出的物体偏向一侧

**解决方案**：
1. 检查两个电机的 PIDF 参数是否相同
2. 检查两个电机的连接和编码器是否正常
3. 在硬件配置中确认电机方向相同（都应该是 REVERSE）

### Q4: 转速档位达不到目标 RPM

**症状**：
- 显示的当前转速总是低于目标转速
- 即使长时间旋转也达不到目标

**解决方案**：
1. 检查 PIDF 参数，特别是 F 值（前馈）
2. 如果 F 值太小，电机无法达到高转速
3. 尝试增加 F 值：`SHOOTER_PIDF_F = 16;` 或 `18;`
4. 检查电池电压是否足够

### Q5: 转速精度范围设置错误

**问题**：
- 转速明明达到了，但还是显示"未达标"
- 或者总是显示"达标"，但发射不准

**解决方案**：
```java
// 查看遥测显示的当前转速波动范围
// 假设显示：1900 ± 40 RPM

// 设置精度范围为波动范围的 1.5 倍
SHOOTER_RPM_ERROR_RANGE_SIDE = 60;  // 原来是 50，改为 60

// 对所有档位都这样调整
```

### Q6: 编译出错 - IMU 找不到

**错误信息**：`hardwareMap.get(IMU.class, "imu") returned null`

**解决方案**：
1. 检查硬件配置文件中 IMU 的名称是否为 "imu"
2. 如果名称不同，修改 `IMU_SENSOR_NAME`
3. 如果没有 IMU，可以注释掉 IMU 相关代码，降级到 v1.0 功能

### Q7: 自动转向不工作

**症状**：
- 按右肩键没反应
- 或者转向到一半就停了

**解决方案**：
1. 检查 IMU 是否已初始化
2. 检查 `AUTO_TURN_TARGET_RIGHT` 是否正确（通常是 45.0）
3. 在遥测中监控 `isAutoTurning` 状态
4. 检查底盘电机是否工作正常

### Q8: 发射流程无法启动

**症状**：
- 按 Y 键没有反应
- 或者转速达标了还是不发射

**解决方案**：
1. 检查 Y 键是否被正确检测
2. 检查转速是否真的达标（看遥测）
3. 确保拾取和装填电机已连接
4. 查看 `fireState` 状态是否改变

---

## 📊 遥测显示说明

### 遥测输出示例

```
========== TeleOp v2.0 ==========
运行时间: 0:00:15.234
状态: 运行中

--- 发射系统 ---
目标转速: 1900 RPM
当前转速: 1895.5 RPM
转速达标: ✓ 是
发射状态: 发射中

--- 导航系统 ---
当前航向: 43.2°
目标航向: 45.0°
自动转向: 进行中
```

### 关键指标解读

| 指标 | 说明 | 正常范围 |
|------|------|--------|
| 目标转速 | 当前选择的转速档位 | 1650-3200 |
| 当前转速 | 实时读取的转速 | 接近目标 ±精度范围 |
| 转速达标 | 是否在精度范围内 | ✓ 是（当前RPM在范围内） |
| 当前航向 | IMU 读取的方向 | -180 到 180° |
| 自动转向 | 是否正在自动转向 | 关闭或进行中 |

---

## 🚀 部署流程详解

### 第一步：准备硬件

```
1. 检查所有电机连接
   □ 4 个底盘电机（lf, rf, lb, rb）
   □ 拾取电机（intake）
   □ 装填电机（load）
   □ 2 个发射电机（s1, s2）
   □ IMU 传感器（imu）

2. 检查编码器
   □ 2 个发射电机都有编码器
   □ 编码器连接正确
```

### 第二步：修改配置

```
1. 打开程序文件
   - 单文件版：TeleOp_All_2_0_0.java
   - 多文件版：RobotConstants_2_0.java

2. 修改硬件名称
   - 根据你的硬件配置修改 9 个硬件名称

3. 修改参数（可选）
   - 转速档位
   - 精度范围
   - IMU PID 参数
```

### 第三步：编译上传

```
1. 在 Android Studio 中编译
2. 连接 USB 上传到控制器
3. 程序会自动初始化所有硬件
```

### 第四步：IMU 校准

```
1. 上传程序后等待 1 秒
2. 让机器人保持平放状态
3. 等待 2-3 秒以完成 IMU 校准
4. 遥测会显示当前航向（应该接近 0°）
```

### 第五步：测试功能

```
按功能逐个测试：

基础功能：
□ 摇杆能控制底盘
□ 底盘能前后移动、左右平移、旋转

拾取系统：
□ A 键启动拾取
□ B 键反向拾取
□ X 键停止

发射系统：
□ D-Pad 能切换档位
□ 遥测显示转速上升
□ 转速达标时 Y 键能启动发射

IMU 系统：
□ 遥测显示当前航向（-180 到 180°）
□ 右肩键自动转向
□ 转向停止时角度接近 45°
```

### 第六步：调优参数

```
1. 根据实际情况调整转速档位
2. 根据精度要求调整精度范围
3. 根据转向效果调整 PID 参数
4. 反复测试直到满意
```

---

## 💡 使用建议

### 转速档位选择建议

```
比赛场景 | 推荐档位 | RPM | 说明
---------|---------|-----|------
远距投篮  | 超远档  | 3200 | 最远距离，要求精度
中距投篮  | 顶点档  | 2400 | 平衡距离和精度
近距投篮  | 腰部档  | 1900 | 最稳定的档位
极近距离  | 底部档  | 1650 | 柔和发射
```

### PID 参数调整流程

```
1. 首先观察转向速度
   - 太慢：增加 P 值
   - 太快或超调：增加 D 值

2. 然后观察精度
   - 不准确：减小 HEADING_THRESHOLD
   - 易抖动：增加 D 值

3. 最后微调
   - 如果还有问题，调整 I 值（通常为 0）
```

---

## 📈 性能优化建议

### 1. 发射稳定性优化

```java
// 增加 PID 的 D 值以减少波动
SHOOTER_PIDF_D = 100;  // 原来是 80

// 增加 F 值以加快转速响应
SHOOTER_PIDF_F = 16;   // 原来是 14
```

### 2. 自动转向精准度优化

```java
// 减小角度精度要求
AUTO_TURN_HEADING_THRESHOLD = 1.0;  // 从 2.0 改为 1.0

// 增加 D 值防止超调
AUTO_TURN_D_GAIN = 0.01;           // 从 0.005 改为 0.01
```

### 3. 低延迟优化

```java
// 使用单文件版本而不是多文件版本
// 编译时间从 3-5 秒减少到 2-3 秒
```

---

## ✅ 部署前最终检查

```
□ 硬件
  □ 所有电机已连接
  □ IMU 已连接
  □ 编码器正常

□ 软件
  □ 硬件名称已修改
  □ 代码能编译通过
  □ 没有 Java 编译错误

□ 初始化
  □ 程序启动后 IMU 已校准
  □ 遥测显示初始化完成

□ 功能
  □ 所有功能都能正常工作
  □ 参数已根据实际调整
  □ 性能达到预期

准备完毕，可以上赛场！🚀
```

---

📝 **最后提醒**：
- 保存每次参数修改
- 记录哪些参数工作良好
- 为不同场地准备不同的参数配置
- 竞赛前充足的时间进行测试和调优

