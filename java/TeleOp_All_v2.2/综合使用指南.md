# 📚 v2.2 综合使用指南

> **修改代码前务必阅读项目根目录的 `修改指南.md`！**

> **v2.2 特点**：
> - ✨ 底盘线性/非线性模式切换
> - 📳 D-Pad 设置转速时手柄震动反馈
> - 🚀 右扳机控制发射启停（D-Pad 仅预设转速）
> - 📊 全面增强的遥测信息

## ⚙️ 快速配置

### 1. 修改硬件名称

**文件位置**：
- 单文件版：TeleOp_All_2_2.java 中的 Constants 类
- 多文件版：RobotConstants_2_2.java

**需要修改的硬件**
```java
// 底盘（与 v1.0 相同）
CHASSIS_MOTOR_FRONT_LEFT_NAME = "lf";
CHASSIS_MOTOR_FRONT_RIGHT_NAME = "rf";
CHASSIS_MOTOR_BACK_LEFT_NAME = "lb";
CHASSIS_MOTOR_BACK_RIGHT_NAME = "rb";

// 子系统（保留 v2.0 的双电机 + 独立控制）
SUBSYSTEM_INTAKE_MOTOR_NAME = "intake";
SUBSYSTEM_LOAD_MOTOR_NAME = "load";
SUBSYSTEM_SHOOTER1_MOTOR_NAME = "s1";      // 第一个发射电机
SUBSYSTEM_SHOOTER2_MOTOR_NAME = "s2";      // 第二个发射电机
IMU_SENSOR_NAME = "imu";                   // IMU 传感器
```

### 2. 修改转速档位

```java
// 4 个转速档位，推荐值基于竞技场地
SHOOTER_RPM_LONG_RANGE = 3200;      // D-Pad 右：超远距离
SHOOTER_RPM_TRIANGLE_SIDE = 1900;   // D-Pad 左：三角腰部
SHOOTER_RPM_TRIANGLE_BASE = 1650;   // D-Pad 下：三角底部
SHOOTER_RPM_TRIANGLE_TOP = 2400;    // D-Pad 上：三角顶点
```

### 3. 修改精度范围

```java
// v2.2 沿用 v2.1 的精度管理，保持与 RobotConstants_2_2.java 一致
SHOOTER_RPM_ERROR_RANGE_LONG = 30;
SHOOTER_RPM_ERROR_RANGE_SIDE = 50;
SHOOTER_RPM_ERROR_RANGE_BASE = 150;
SHOOTER_RPM_ERROR_RANGE_TOP = 35;
```

### 4. 修改 IMU 自动转向参数

```java
AUTO_TURN_TARGET_RIGHT = 45.0;          // 右肩键转向角度

// PID 参数（控制转向平稳性）
AUTO_TURN_P_GAIN = 0.1;                 // 比例项（控制快速响应）
AUTO_TURN_I_GAIN = 0.0;                 // 积分项（消除误差）
AUTO_TURN_D_GAIN = 0.005;               // 微分项（防止超调）

AUTO_TURN_HEADING_THRESHOLD = 2.0;      // 到达目标的精度（±2°）
```

### 5. 手柄震动时长

```java
RUMBLE_DURATION_MS = 200; // D-Pad 设置转速时手柄震动时长（毫秒）
```

---

## 🎮 完整按键参考（v2.2 增强版）

| 分类 | 按键 | 功能 | 说明 |
|------|------|------|------|
| **底盘** | 左摇杆↑↓ | 前后移动 | 向上前进、向下后退 |
| | 左摇杆← → | 左右平移 | 平行移动 |
| | 右摇杆← → | 原地旋转 | 灵敏度 80% |
| | **Y 键** | **底盘模式切换** | **切换线性/非线性 (Squared) 驱动模式** |
| **拾取** | A 键 | 拾取进 | 启动拾取电机（独立） |
| | B 键 | 拾取退 | 拾取反向（独立） |
| **装填** | LT 键 | 装填进 | 启动装填电机（独立） |
| | LB 键 | 装填反 | 装填反向（独立） |
| **发射档位** | D-Pad → | 超远档 | 3200 RPM，设置成功手柄震动 |
| | D-Pad ← | 腰部档 | 1900 RPM，设置成功手柄震动 |
| | D-Pad ↓ | 底部档 | 1650 RPM，设置成功手柄震动 |
| | D-Pad ↑ | 顶点档 | 2400 RPM，设置成功手柄震动 |
| **发射控制** | **RT (右扳机)** | **发射/停止** | **按住启动发射，松开停止（怠速）** |
| **导航** | RB (右肩键) | 自动转向 | 自动向右转45° |

---

## ⚡ v2.2 调试流程

> v2.2 最大优势：系统独立，功能增强，可逐个调试

### 第一步：调试底盘（含模式切换）

```
操作：左摇杆 + 右摇杆 + Y 键
检查项：
□ 左摇杆↑↓←→，右摇杆←→ 功能正常
□ 按 Y 键，遥测的“移动模式”在“线性 (Linear)”和“非线性 (Squared)”之间切换
□ 两种模式下，感受底盘操控的差异（非线性在低速更平滑）
```

### 第二步：调试拾取（A/B）

```
操作：只按 A 和 B 键，不按其他任何键
检查项：
□ A 键 → 拾取电机正向旋转（吸入小球），遥测“拾取模块”显示“吸入”
□ B 键 → 拾取电机反向旋转（推出小球），遥测“拾取模块”显示“吐出”
□ 松开 → 拾取电机停止，遥测显示“停止”

注意：v2.2 中 A/B 只控制拾取，不影响装填和发射
```

### 第三步：调试装填（LT/LB）

```
操作：只按 LT 和 LB 键，不按其他任何键
检查项：
□ LT 键 → 装填电机正向旋转，遥测“装填模块”显示“装填”
□ LB 键 → 装填电机反向旋转，遥测“装填模块”显示“退回”
□ 松开 → 装填电机停止，遥测显示“停止”

注意：v2.2 中 LT/LB 只控制装填，不影响拾取和发射
```

### 第四步：调试发射档位（D-Pad）与震动反馈

```
操作：按 D-Pad 的 ←↑→↓ 设置档位，观察遥测，感受手柄震动
检查项：
□ D-Pad → → 遥测显示 3200 RPM，手柄震动
□ D-Pad ← → 遥测显示 1900 RPM，手柄震动
□ D-Pad ↓ → 遥测显示 1650 RPM，手柄震动
□ D-Pad ↑ → 遥测显示 2400 RPM，手柄震动

注意：此时发射电机不应旋转，遥测的 S1/S2 转速应为 0
```

### 第五步：调试发射（RT 扳机控制）

```
操作：先按 D-Pad 设置档位，然后使用 RT
检查项：
□ 设置档位后，按住 RT → 发射电机启动并加速到目标转速，遥测 S1/S2 转速上升
□ 遥测显示“转速达标”为“✓ 是”
□ 松开 RT → 发射电机停止（怠速），遥测 S1/S2 转速降至 0

注意：发射完全独立，不受拾取/装填影响
```

### 第六步：调试自动转向（RB）

```
操作：按 RB (右肩键)，观察机器人转向和遥测
检查项：
□ 按 RB → 机器人开始自动转向，遥测“自动转向”显示“进行中”
□ 机器人转向到 45° 附近时停止，遥测“自动转向”显示“关闭”
□ 遥测“当前航向”最终接近 45°
```

### 第七步：集成测试

```
尝试完整的比赛动作序列：
1. 使用摇杆移动机器人到适当位置，并尝试切换底盘模式
2. 按 A 键启动拾取
3. 按 D-Pad 设置发射档位（感受震动）
4. 按 LT 启动装填
5. 等待遥测显示转速达标（S1/S2 RPM 接近目标，转速达标显示“✓ 是”）
6. 按住 RT 启动发射
7. 发射完成后松开 RT 停止
8. 尝试按 RB 进行自动转向
```

---

## 🔧 常见问题和解决方案（v2.2）

### Q1: 拾取和装填无法同时工作

**v1.0/v2.0 问题，v2.2 已完全解决！**

在 v2.2 中，拾取、装填、发射三个系统完全独立：
- A/B 只控制拾取
- LT/LB 只控制装填
- RT 只控制发射

这意味着你可以：
```
同时按下 A + LT → 拾取进 + 装填进
同时按下 B + LB → 拾取反 + 装填反
同时按下 A + RT → 拾取进 + 发射（如果达标）
```

### Q2: 转速档位达不到目标或波动大

**症状**：
- 显示的当前转速总是低于目标转速
- 发射电机转速不稳定，波动范围大

**解决方案**：
1. 检查电池电压是否足够（应该 > 11V）
2. 检查发射电机是否卡住，有无异物阻碍
3. 调整 PIDF 参数：
   - **F 值 (前馈)**：适当增加 F 值可以更快达到目标转速（如从 14 改为 16-18）。
   - **P 值 (比例)**：影响响应速度，过大会超调。可微调。
   - **D 值 (微分)**：有助于抑制超调和震荡，可适当增加。
4. 检查精度范围是否设置得太严格（见 Q3）。

### Q3: 转速达标状态不准确

**问题**：转速明明接近目标，但遥测仍显示"✗ 否"

**解决方案**：
1.  **观察实际波动**：在遥测中观察“S1转速”和“S2转速”在稳定状态下的波动范围。
2.  **调整精度范围**：在 `RobotConstants_2_2.java` 中找到对应的 `SHOOTER_RPM_ERROR_RANGE_XXX` 常量。
    *   例如，如果目标 3200 RPM，实际在 3180-3220 RPM 波动，那么 `SHOOTER_RPM_ERROR_RANGE_LONG` 可以设置为 30 (±30 RPM)。
    *   如果波动较大，例如 ±50 RPM，则需要将精度范围设置得更大（例如 60）。

### Q4: IMU 读数异常或自动转向不工作

**症状**：
- 显示的航向角度不合理（如一直为 0 或固定值）
- 按右肩键没反应，机器人不转向

**解决方案**：
1. 检查 IMU 是否已正确连接到控制器。
2. 上传程序后，让机器人**平放静止 2-3 秒**，等待 IMU 初始化和校准。
3. 检查 `RobotConstants_2_2.java` 中 `IMU_SENSOR_NAME` 是否与硬件配置中的 IMU 名称一致（默认 "imu"）。
4. 如果 PID 调整不当可能导致转向失效，可尝试微调 `AUTO_TURN_P_GAIN`, `AUTO_TURN_I_GAIN`, `AUTO_TURN_D_GAIN`。

### Q5: 编译出错 - 文件名或类名错误

**错误信息**：`cannot find symbol: class TeleOp_2_1` 或 `TeleOp_All_2_1`

**解决方案**：
确认你使用的是 v2.2 的文件，并且代码中所有对其他模块的引用都是 `_2_2` 后缀。
```
✗ 错误 → 引用了 `RobotConstants_2_1`
✓ 正确 → 引用了 `RobotConstants_2_2`
```

### Q6: 底盘模式切换没有效果

**症状**：按 Y 键后，遥测“移动模式”没有变化，或者感觉不到底盘行为的改变。

**解决方案**：
1. 确保 `ControlInputManager_2_2.java` 中 `isYButtonPressed()` 方法正常工作。
2. 确保 `TeleOp_2_2.java` 或 `TeleOp_All_2_2.java` 中正确调用了 `chassis.toggleDriveMode()`。
3. 在遥测中观察 `移动模式` 字段是否在切换。
4. 尝试在非线性模式下，用很小的摇杆输入来感受其更柔和的响应。

---

## 📊 遥测显示说明

### 遥测输出示例（v2.2）

```
========== TeleOp v2.2 ==========
运行时间: 0:00:20.123

--- 发射系统 ---
目标转速: 1900 RPM
S1转速: 1898.7 RPM
S2转速: 1901.2 RPM
转速达标: ✓ 是

--- 底盘与导航 ---
移动模式: 非线性 (Squared)
当前航向: 44.8°
自动转向: 关闭

--- 状态 ---
拾取模块: 吸入
装填模块: 装填

--- 按键说明 ---
Y:切换底盘模式 | Dpad:预设转速
RT:发射(需按住) | RB:自动转向
A/B:拾取 | LT/LB:装填
```

### 关键指标解读

| 指标 | 说明 | 正常范围 |
|------|------|--------|
| 运行时间 | 程序运行的总时间 | 递增 |
| 目标转速 | D-Pad 当前设置的发射转速 | 预设档位值 |
| S1转速 | 第一个发射电机的实时转速 | 接近目标 ±精度 |
| S2转速 | 第二个发射电机的实时转速 | 接近目标 ±精度 |
| 转速达标 | 当前 S2 转速是否在目标 ±精度范围内 | ✓ 是 / ✗ 否 |
| 移动模式 | 底盘当前驱动模式 | 线性 (Linear) / 非线性 (Squared) |
| 当前航向 | IMU 读取的机器人当前航向 | -180 到 180° |
| 自动转向 | 自动转向功能是否活跃 | 进行中 / 关闭 |
| 拾取模块 | 拾取电机的当前状态 | 吸入 / 吐出 / 停止 |
| 装填模块 | 装填电机的当前状态 | 装填 / 退回 / 停止 |
| 按键说明 | 简要的操作指南 | 固定文本 |

---

## 🚀 部署流程详解

### 第一步：准备硬件

```
1. 检查所有电机连接
   □ 4 个底盘电机（lf, rf, lb, rb）
   □ 拾取电机（intake）
   □ 装填电机（load）
   □ 2 个发射电机（s1, s2）
   □ IMU 传感器（imu）

2. 检查编码器
   □ 2 个发射电机都有编码器
   □ 编码器连接正确
```

### 第二步：修改配置

```
1. 打开程序文件
   - 单文件版：TeleOp_All_2_2.java
   - 多文件版：RobotConstants_2_2.java

2. 修改硬件名称
   - 根据你的硬件配置修改 9 个硬件名称

3. 修改参数（可选）
   - 转速档位
   - 精度范围
   - IMU PID 参数
   - 手柄震动时长
```

### 第三步：编译上传

```
1. 在 Android Studio 中编译
2. 连接 USB 上传到控制器
3. 程序会自动初始化所有硬件
```

### 第四步：IMU 校准

```
1. 上传程序后等待 1 秒
2. 让机器人保持平放状态
3. 等待 2-3 秒以完成 IMU 校准
4. 遥测会显示当前航向（应该接近 0°）
```

### 第五步：测试功能

```
按功能逐个测试（参考上文“v2.2 调试流程”）：

□ 底盘移动（含模式切换）
□ 拾取系统
□ 装填系统
□ 发射档位设置与震动
□ 发射模块 RT 启停
□ 自动转向
□ 遥测信息显示
```

### 第六步：调优参数

```
1. 根据实际情况调整转速档位
2. 根据精度要求调整精度范围
3. 根据转向效果调整 PID 参数
4. 反复测试直到满意
```

---

## 💡 使用建议

### 转速档位选择建议

```
比赛场景 | 推荐档位 | RPM | 说明
---------|---------|-----|------
远距投篮  | 超远档  | 3200 | 最远距离，要求精度
中距投篮  | 顶点档  | 2400 | 平衡距离和精度
近距投篮  | 腰部档  | 1900 | 最稳定的档位
极近距离  | 底部档  | 1650 | 柔和发射
```

### PID 参数调整流程

```
1. 首先观察转向速度
   - 太慢：增加 P 值
   - 太快或超调：增加 D 值

2. 然后观察精度
   - 不准确：减小 HEADING_THRESHOLD
   - 易抖动：增加 D 值

3. 最后微调
   - 如果还有问题，调整 I 值（通常为 0）
```

---

## 📈 性能优化建议

### 1. 发射稳定性优化

```java
// 增加 PID 的 D 值以减少波动
SHOOTER_PIDF_D = 100;  // 原来是 80

// 增加 F 值以加快转速响应
SHOOTER_PIDF_F = 16;   // 原来是 14
```

### 2. 自动转向精准度优化

```java
// 减小角度精度要求
AUTO_TURN_HEADING_THRESHOLD = 1.0;  // 从 2.0 改为 1.0

// 增加 D 值防止超调
AUTO_TURN_D_GAIN = 0.01;           // 从 0.005 改为 0.01
```

### 3. 低延迟优化

```java
// 使用单文件版本而不是多文件版本
// 编译时间从 3-5 秒减少到 2-3 秒
```

---

## ✅ 部署前最终检查

```
□ 硬件
  □ 所有电机已连接
  □ IMU 已连接
  □ 编码器正常

□ 软件
  □ 硬件名称已修改
  □ 代码能编译通过
  □ 没有 Java 编译错误

□ 初始化
  □ 程序启动后 IMU 已校准
  □ 遥测显示初始化完成

□ 功能
  □ 所有功能都能正常工作
  □ 参数已根据实际调整
  □ 性能达到预期

准备完毕，可以上赛场！🚀
```

---

📝 **最后提醒**：
- 保存每次参数修改
- 记录哪些参数工作良好
- 为不同场地准备不同的参数配置
- 竞赛前充足的时间进行测试和调优

