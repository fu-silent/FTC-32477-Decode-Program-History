# 🔧 FTC32477 程序修改指南

> **重要：在对本项目进行任何修改之前，请务必阅读本文档！**

## 📋 项目基本信息

### 项目描述
- **队伍**：FTC32477
- **赛季**：Decode（2025-2026 赛季）
- **程序类型**：远程遥控(TeleOp)控制程序
- **主要功能**：
  - 麦克纳姆轮底盘全向移动（前后、左右、旋转，支持线性/非线性模式切换）
  - 拾取系统（正向、反向）
  - 装填系统
  - 发射系统（D-Pad 预设转速，右扳机启动/停止，带震动反馈）
  - IMU 自动转向控制

### 赛季主题背景
**Decode 赛季**要求机器人能够：
1. 拾取游戏物体
2. 运输和装填
3. 发射到目标区域

本程序为完整的远程遥控解决方案。

---

## ⚠️ 关键修改原则

### 原则 1：先修改分布式文件，再修改集中式文件

**分布式（多文件）版本**：
```
TeleOp_All_v2.2/
├── TeleOp_2_2.java
├── ChassisDriveSystem_2_2.java
├── SubsystemManager_2_2.java
├── ControlInputManager_2_2.java
├── RobotConstants_2_2.java
├── NavigationSystem_2_2.java
└── TelemetryManager_2_2.java
```

**集中式（单文件）版本**：
```
TeleOp_All_v2.2/
└── TeleOp_All_2_2.java (内部8个类，推荐竞赛部署)
```

**修改流程**：
1. ✅ 修改多文件版本的相应源文件
2. ✅ 验证多文件版本编译无误
3. ✅ 将相同改动集成到单文件版本的对应内部类
4. ✅ 验证单文件版本编译无误

### 原则 2：版本号一致性

所有文件和类必须遵循版本号约定：
- **v1.0** 系列：所有文件/类名后缀为 `_1_0`
- **v2.0** 系列：所有文件/类名后缀为 `_2_0`
- **v2.1** 系列：所有文件/类名后缀为 `_2_1`
- **v2.2** 系列：所有文件/类名后缀为 `_2_2`

**强制规则**：
- 类名必须与文件名中的版本号相匹配
- 所有相互引用的类名必须一致
- 构造函数名必须与类名相同

### 原则 3：独立性原则

v1.0、v2.0、v2.1、v2.2 完全独立：
- ❌ 不允许跨版本引用类（如 v1.0 引用 v2.2）
- ❌ 不允许混用版本常量
- ✅ 不同版本可有相同的功能但独立实现
- ⚠️ v2.2 基于 v2.1 优化，可参考 v2.1 原理但独立实现

### 原则 4：v2.2 特殊性

v2.2 是 v2.1 的增强版本，有以下核心改动：
1. **底盘模式切换** - ChassisDriveSystem_2_2 实现了线性/非线性（平方）驱动模式切换，按 Y 键控制。
2. **手柄震动反馈** - ControlInputManager_2_2 实现了 D-Pad 设置转速时的手柄震动反馈。
3. **发射逻辑优化** - SubsystemManager_2_2 实现 D-Pad 仅设置转速，右扳机（RT）负责发射模块的启动和停止。
4. **遥测信息增强** - TelemetryManager_2_2 提供了更全面的遥测信息显示。

---

## 🔄 常见修改场景

### 场景 1：修改底盘运动公式或模式

**涉及文件**：
- 多文件：`ChassisDriveSystem_2_2.java`
- 单文件：`TeleOp_All_2_2.java` 中的 `ChassisDrive` 内部类

**修改步骤**：
1. 打开多文件版本的 `ChassisDriveSystem_2_2.java`
2. 找到 `update()` 方法，修改麦克纳姆轮公式或 `isNonLinearMode` 逻辑
3. 验证编译无误
4. 在单文件版 `TeleOp_All_2_2.java` 中找到 `ChassisDrive` 内部类
5. 找到对应的功率计算逻辑和模式切换逻辑
6. 应用同样的修改
7. 验证编译无误

### 场景 2：修改控制输入映射或震动反馈

**涉及文件**：
- 多文件：`ControlInputManager_2_2.java`
- 单文件：`TeleOp_All_2_2.java` 中的 `ControlInput` 内部类

**修改步骤**：
1. 打开多文件版本的 `ControlInputManager_2_2.java`
2. 修改 `getChassisDriveFBInput()`、`getChassisStrafeLRInput()`、`getChassisRotateCWInput()`、`isYButtonPressed()` 等方法，或调整 `rumble()` 逻辑。
3. 在单文件版 `TeleOp_All_2_2.java` 中找到 `ControlInput` 内部类
4. 找到对应的方法并应用同样的修改
5. 编译验证

### 场景 3：修改发射系统参数或逻辑

**涉及文件**：
- 多文件：`RobotConstants_2_2.java` 和 `SubsystemManager_2_2.java`
- 单文件：`TeleOp_All_2_2.java` 中的 `Constants` 和 `Subsystems` 内部类

**修改步骤**：
1. 修改 `RobotConstants_2_2.java` 中的发射参数常量（如 `SHOOTER_RPM_LONG_RANGE` 等）
2. 在 `SubsystemManager_2_2.java` 中修改 `setShooterTargetRPM()` 和 `setShootingState()` 方法中的逻辑
3. 在单文件版中的 `Constants` 内部类修改同样的常量
4. 在 `Subsystems` 内部类中修改同样的逻辑
5. 编译验证

### 场景 4：修改遥测显示内容

**涉及文件**：
- 多文件：`TelemetryManager_2_2.java`
- 单文件：`TeleOp_All_2_2.java` 中的 `TelemetryDisplay` 内部类

**修改步骤**：
1. 打开 `TelemetryManager_2_2.java`
2. 修改 `displayFullTelemetry()` 方法中的输出内容和格式
3. 在单文件版中的 `TelemetryDisplay` 内部类同步修改
4. 编译验证

---

## 📝 修改检查清单

修改任何代码前，请检查以下内容：

### 修改前
- [ ] 我已阅读本修改指南
- [ ] 我知道这个改动涉及哪些文件（分布式和/或集中式）
- [ ] 我已理解版本号一致性要求
- [ ] 我有一个明确的目标（例如"修复逆时针旋转"）

### 修改中
- [ ] 我先修改了多文件版本的源文件
- [ ] 我验证了多文件版本能编译
- [ ] 我后修改了单文件版本的对应内部类
- [ ] 我在两个版本中使用了一致的版本号后缀（_2_2）
- [ ] 我保持了代码的一致性和对称性

### 修改后
- [ ] 两个版本都能编译无误
- [ ] 我更新了相关的文档说明
- [ ] 我测试了修改后的功能
- [ ] 我验证了没有引入新的 bug

---

## 🎮 版本控制映射对比

### 所有版本底盘控制（通用）
| 输入 | 来源 | 功能 |
|------|------|------|
| **前后移动** | 左摇杆 Y轴 | drive（正=前，负=后） |
| **左右平移** | 左摇杆 X轴 | strafe（正=右，负=左） |
| **原地旋转** | 右摇杆 X轴 | turn（正=顺时针，负=逆时针） |

### v2.2 子系统控制（增强推荐 ⭐）
| 功能 | 按键 | 说明 |
|------|------|------|
| **底盘模式** | Y | **切换线性/非线性 (Squared) 模式** |
| **拾取正向** | A | 独立系统 |
| **拾取反向** | B | 独立系统 |
| **装填启动** | LT | 独立系统 |
| **装填反转** | LB | 独立系统 |
| **设置超远转速** | D-Pad 右 | 3200 RPM (**设置成功震动**) |
| **设置腰部转速** | D-Pad 左 | 1900 RPM (**设置成功震动**) |
| **设置底部转速** | D-Pad 下 | 1650 RPM (**设置成功震动**) |
| **设置顶点转速** | D-Pad 上 | 2400 RPM (**设置成功震动**) |
| **发射模块启停** | RT (右扳机) | **按住启动，松开停止（怠速）** |
| **自动转向** | RB (右肩键) | IMU 导航 |
| **精度范围** | 所有 | **±30-150 RPM (根据档位自适应)** |

---

## 🚫 禁止项和风险操作

### ❌ 禁止操作
1. **混合两个版本的代码**
   - 不要在 v2.1 中使用 v2.2 的类
   - 不要在 `_2_1` 和 `_2_2` 中混合后缀

2. **不一致的版本号**
   - 所有相关文件和类必须使用同一个版本号后缀
   - 例：如果用 `_2_2`，所有 v2.2 文件都应该是 `_2_2`

3. **忘记同步修改**
   - 修改多文件版本后必须同时修改单文件版本
   - 修改单文件版本后需要反向同步到多文件版本（如有必要）

4. **改动硬件映射名称后忘记验证**
   - 修改 `CHASSIS_MOTOR_FRONT_LEFT_NAME` 等常量后必须确保对应的硬件有该名称

### ⚠️ 风险操作
1. **大规模重构**
   - 建议一次只修改一个功能模块
   - 修改后立即编译测试

2. **删除"似乎未使用"的代码**
   - 某些代码可能在特定模式下使用
   - 删除前先搜索所有引用

3. **修改基础的数学公式**
   - 底盘控制、PID、坐标变换等
   - 修改前充分理解原理，修改后充分测试

---

## 📝 版本历史和已知改动

### v2.2 改动记录（最新推荐版本 ⭐）
- **2025-12-07**：
  - ✅ 完成 v2.2 版本增强
  - ✅ ChassisDriveSystem_2_2：新增底盘线性/非线性模式切换（Y 键）
  - ✅ ControlInputManager_2_2：新增 D-Pad 设置转速时的手柄震动反馈
  - ✅ SubsystemManager_2_2：优化发射逻辑，D-Pad 仅设置转速，右扳机（RT）控制发射启停（按住发射，松开怠速）
  - ✅ TelemetryManager_2_2：完善遥测信息，包括运行时间、目标转速、S1/S2 转速、转速达标状态、底盘模式、装填/拾取模块状态、当前航向、自动转向状态和简短按键说明。
  - ✅ 完成单文件版本 TeleOp_All_2_2.java 集成
  - ✅ 所有文档更新至 v2.2

### v2.1 改动记录
- **2025-12-05**：
  - ✅ 完成 v2.1 版本优化
  - ✅ SubsystemManager_2_1：三个系统完全独立（无联动）
  - ✅ RobotConstants_2_1：所有档位精度统一 ±200 RPM
  - ✅ ControlInputManager_2_1：恢复 v1.0 风格按键映射（A/B/LT/LB/RT）
  - ✅ 转速档位优化：1800/1400/1200/1650 RPM
  - ✅ 完成单文件版本 TeleOp_All_2_1.java 集成
  - ✅ 所有文档更新至 v2.1

### v2.0 改动记录
- **2025-12-04**：
    - ✅ 修复麦克纳姆轮公式中的后轮 strafe 符号错误

### v1.0 改动记录
- **2025-12-05**：
  - ✅ 增加装填模块反转功能，左肩键(LB)控制装填反向
  - ✅ 在 ControlInputManager_1_0.java 添加 isLoadReverseRequested() 方法
  - ✅ 在 SubsystemManager_1_0.java 添加 loadReverse() 方法
  - ✅ 在 TeleOp_1_0.java 和 TeleOp_All_1_0.java 中集成装填反转控制逻辑
  - ✅ 更新遥测显示和文档，说明新的按键映射

- **2025-12-04**：
  - ✅ 删除所有转速(RPM)相关代码，改为发射功率控制（0.0-1.0，步长0.05）
  - ✅ 修复麦克纳姆轮公式中的后轮 strafe 符号错误
  - ✅ 交换左右摇杆的功能（左摇杆=前后+旋转，右摇杆=平移）
  - ✅ 实现摇杆无输入时的立即刹停（BRAKE 行为）
  - ✅ 删除 v1.0 中所有转速遗留代码和注释


---

## 📚 相关文档

| 文档 | 用途 |
|------|------|
| **README.md** | 项目快速入门 |
| **综合使用指南.md** | 配置、按键、常见问题 |
| **功能对比文档.md** | 原理和架构详解 |
| **修改指南.md** | 本文档，修改前必读 |

---

## ✅ 修改流程总结

```
1. 阅读本修改指南
   ↓
2. 确定要修改的功能和涉及的文件
   ↓
3. 修改多文件版本（v2.2）
   ↓
4. 编译多文件版本，验证无误
   ↓
5. 修改对应的单文件版本
   ↓
6. 编译单文件版本，验证无误
   ↓
7. 更新相关文档
   ↓
8. 测试功能，确保没有新的 bug
   ↓
9. 完成！✅
```

---

## 📊 版本选择建议

| 场景 | 推荐版本 | 理由 |
|------|--------|------|
| **竞赛部署** | v2.2 单文件 | 调试快（20分钟）+功能增强 |
| **赛前调试** | v2.2 | 独立系统+非线性底盘 |
| **学习研究** | v2.0 多文件 | 功能完整+代码规范 |
| **生产运行** | v2.2 | 稳定+可靠 |

## 📂 文件验证清单

修改后建议进行以下验证：

### 快速验证步骤

**1. 检查版本号一致性**
```bash
ls -la *.java | grep _2_2
# 应该看到所有 v2.2 文件
```

**2. v2.2 特殊验证**
```bash
# 检查底盘模式切换
grep "toggleDriveMode" ChassisDriveSystem_2_2.java

# 检查手柄震动
grep "rumble" ControlInputManager_2_2.java

# 检查发射逻辑（D-Pad只设转速，RT启动）
grep "setShooterRPM" TeleOp_2_2.java
grep "setShootingState" TeleOp_2_2.java

# 检查遥测内容
grep -E "运行时间|目标转速|S1转速|移动模式" TelemetryManager_2_2.java
```

### 编译验证清单
- [ ] 多文件版本能正常编译
- [ ] 单文件版本能正常编译
- [ ] 没有版本号不匹配的编译错误
- [ ] 没有类名重复定义错误

### 功能验证清单（v2.2）
- [ ] 拾取系统可独立控制（A/B 按键）
- [ ] 装填系统可独立控制（LT/LB 按键）
- [ ] 发射系统可独立控制（RT + D-Pad）
- [ ] 三个系统无联动（按一个不影响其他）
- [ ] D-Pad 设置转速时手柄震动
- [ ] 右扳机按住时发射模块启动，松开停止
- [ ] Y 键可切换底盘的线性/非线性模式
- [ ] 遥测信息显示完整且正确

---

**最后更新**：2025-12-07  
**维护者**：FTC32477 编程组  
**质量**：生产级文档  
**当前推荐**：v2.2（功能增强+更优体验）
