# 🔧 FTC32477 程序修改指南 (v2.3)

> **重要：在对本项目进行任何修改之前，请务必阅读本文档！**

## 📋 项目基本信息

- **队伍**：FTC32477
- **赛季**：Decode（2025-2026 赛季）
- **当前版本**：v2.3
- **核心功能**：
  - **无头模式 (Field-Centric)**：新增，按 X 键切换，极大提升操控直观性。
  - **IMU 航向重置**：新增，按 Back 键重置，用于校准无头模式。
  - **双模式底盘**：线性/非线性驱动模式切换 (Y 键)。
  - **高级发射系统**：D-Pad 预设转速，右扳机 (RT) 控制启停，带震动反馈。
  - **IMU 自动转向**：PID 控制的自动转向功能。

---

## ⚠️ 关键修改原则

### 原则 1：版本与文件结构

**分布式（多文件）版本 (v2.3)**：
```
TeleOp_All_v2.3/
├── TeleOp_2_3.java
├── ChassisDriveSystem_2_3.java (含无头模式逻辑)
├── NavigationSystem_2_3.java (含IMU重置)
├── ControlInputManager_2_3.java (新增X和Back键)
├── SubsystemManager_2_3.java
├── RobotConstants_2_3.java
└── TelemetryManager_2_3.java
```

**集中式（单文件）版本 (v2.3)**：
```
TeleOp_All_v2.3/
└── TeleOp_All_2_3.java (内部8个类，推荐竞赛部署)
```

### 原则 2：版本号一致性

所有文件和类必须遵循版本号约定（例如 `_2_3`）。修改时请确保所有相关文件的版本号一致。

### 原则 3：独立性原则

不同版本（v1.0, v2.0, v2.1, v2.2, v2.3）完全独立，不允许跨版本引用类或常量。

### 原则 4：v2.3 特殊性

v2.3 是 v2.2 的功能增强版，核心改动如下：
1.  **无头模式 (Field-Centric)**：`ChassisDriveSystem_2_3` 新增，通过 `toggleCentricMode()` 切换。
2.  **IMU 重置**：`NavigationSystem_2_3` 新增 `resetYaw()` 方法，用于在任何时候校准“前向”。
3.  **新增按键**：`ControlInputManager_2_3` 新增 `isXButtonPressed()` 和 `isOptionsPressed()`。
4.  **遥测更新**：`TelemetryManager_2_3` 更新以显示驱动模式（含无头模式）和新的按键说明。

---

## 🔄 常见修改场景 (v2.3)

### 场景 1：调整无头模式 (Field-Centric) 逻辑

**涉及文件**：
-   多文件：`ChassisDriveSystem_2_3.java`
-   单文件：`TeleOp_All_2_3.java` 中的 `ChassisDrive` 内部类

**修改步骤**：
1.  打开 `ChassisDriveSystem_2_3.java`。
2.  在 `update()` 方法中找到“无头模式坐标转换”部分。
3.  修改 `rotX` 和 `rotY` 的计算公式。例如，如果 IMU 安装方向改变，可能需要调整 `botHeading` 的符号或 `sin`/`cos` 的使用。
4.  在单文件版的对应内部类中同步修改。

### 场景 2：修改 IMU 重置逻辑

**涉及文件**：
-   多文件：`NavigationSystem_2_3.java` 和 `ControlInputManager_2_3.java`
-   单文件：`TeleOp_All_2_3.java` 中的 `Navigation` 和 `ControlInput` 内部类

**修改步骤**：
1.  在 `ControlInputManager_2_3.java` 中找到 `isOptionsPressed()`，可以修改触发按键（例如改为 `start` 键）。
2.  在 `NavigationSystem_2_3.java` 中找到 `resetYaw()`，该方法封装了 `imu.resetYaw()`。
3.  在主程序 `TeleOp_2_3.java` 中，修改 `updateControlInputs()` 中调用 `navigation.resetYaw()` 的条件。

---

## 🎮 版本控制映射对比 (v2.3 最新)

| 功能 | 按键 | 说明 |
|---|---|---|
| **底盘模式** | Y | 切换 **线性 / 非线性 (Squared)** 模式 |
| **驱动中心** | X | 切换 **有头 (Robot) / 无头 (Field)** 模式 |
| **IMU 重置** | Back/Options | **重置当前方向为“前”**，用于校准无头模式 |
| **发射模块** | RT (右扳机) | 按住启动，松开停止 |
| **转速预设** | D-Pad | 设置目标转速（伴随震动） |
| **自动转向** | RB (右肩键) | 自动转向到预设角度 |
| **拾取/装填** | A/B/LT/LB | 独立控制，与 v2.2 相同 |

---

## 📝 修改检查清单 (v2.3)

修改任何代码前，请检查以下内容：

### 功能验证清单 (v2.3)
-   [ ] Y 键可切换底盘的线性/非线性模式。
-   [ ] **X 键可切换有头/无头模式，遥测信息正确显示。**
-   [ ] **在无头模式下，无论车头朝向，向前推摇杆车都朝场地前方行驶。**
-   [ ] **按下 Back 键，当前车头方向被重置为新的“前向”。**
-   [ ] D-Pad 设置转速时手柄震动。
-   [ ] 右扳机按住时发射模块启动，松开停止。
-   [ ] 拾取、装填、自动转向功能正常。

---

## 📝 版本历史

### v2.3 改动记录 (最新推荐 ⭐)
-   **2025-12-10**：
    -   ✅ **新增无头模式 (Field-Centric)**，通过 X 键切换，极大提升驾驶效率。
    -   ✅ **新增 IMU 航向重置功能**，通过 Back/Options 键实现，随时校准“前向”。
    -   ✅ ChassisDriveSystem_2_3：构造函数增加 `Navigation` 依赖，以获取航向角。
    -   ✅ ControlInputManager_2_3：增加 X 和 Back 键的边缘检测。
    -   ✅ TelemetryManager_2_3：更新遥测显示，包含驱动模式和新按键说明。
    -   ✅ 所有相关文件版本号更新至 v2.3。

### v2.2 改动记录
-   **2025-12-05**：
    -   ✅ 新增底盘线性/非线性模式切换（Y 键）。
    -   ✅ 新增 D-Pad 设置转速时的手柄震动反馈。
    -   ✅ 优化发射逻辑，D-Pad 仅设置转速，RT 控制启停。
    -   ✅ 完善遥测信息。

---

**最后更新**：2025-12-12
**当前推荐**：v2.3 (无头模式 + 功能增强)
