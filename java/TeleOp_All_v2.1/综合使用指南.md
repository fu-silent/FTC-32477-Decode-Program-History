# 📚 v2.1 综合使用指南

> **修改代码前务必阅读项目根目录的 `修改指南.md`！**

> **v2.1 特点**：
> - ✨ 恢复直观的 v1.0 按键映射
> - 🎯 三个系统完全独立控制
> - 📊 统一精度范围（所有±200 RPM）
> - ⚡ 更快的调试流程

## ⚙️ 快速配置

### 1. 修改硬件名称

**文件位置**：
- 单文件版：TeleOp_All_2_1.java 中的 Constants 类
- 多文件版：RobotConstants_2_1.java

**需要修改的硬件**
```java
// 底盘（与 v1.0 相同）
CHASSIS_MOTOR_FRONT_LEFT_NAME = "lf";
CHASSIS_MOTOR_FRONT_RIGHT_NAME = "rf";
CHASSIS_MOTOR_BACK_LEFT_NAME = "lb";
CHASSIS_MOTOR_BACK_RIGHT_NAME = "rb";

// 子系统（保留 v2.0 的双电机 + 独立控制）
SUBSYSTEM_INTAKE_MOTOR_NAME = "intake";
SUBSYSTEM_LOAD_MOTOR_NAME = "load";
SUBSYSTEM_SHOOTER1_MOTOR_NAME = "s1";      // 第一个发射电机
SUBSYSTEM_SHOOTER2_MOTOR_NAME = "s2";      // 第二个发射电机
IMU_SENSOR_NAME = "imu";                   // IMU 传感器
```

### 2. 修改转速档位（v2.1 新档位）

```java
// 4 个转速档位，推荐值基于竞技场地
SHOOTER_RPM_LONG_RANGE = 1800;      // D-Pad 右：超远距离
SHOOTER_RPM_TRIANGLE_SIDE = 1400;   // D-Pad 左：三角腰部
SHOOTER_RPM_TRIANGLE_BASE = 1200;   // D-Pad 下：三角底部
SHOOTER_RPM_TRIANGLE_TOP = 1650;    // D-Pad 上：三角顶点
```

### 3. 修改精度范围（v2.1 统一）

```java
// v2.1：所有档位的精度范围统一为 ±200 RPM
// 这样便于一次性调试和部署
SHOOTER_RPM_ERROR_RANGE = 200;      // 所有档位：±200 RPM（统一）
```

### 4. 修改 IMU 自动转向参数

```java
AUTO_TURN_TARGET_RIGHT = 45.0;          // 右肩键转向角度

// PID 参数（控制转向平稳性）
AUTO_TURN_P_GAIN = 0.1;                 // 比例项（控制快速响应）
AUTO_TURN_I_GAIN = 0.0;                 // 积分项（消除误差）
AUTO_TURN_D_GAIN = 0.005;               // 微分项（防止超调）

AUTO_TURN_HEADING_THRESHOLD = 2.0;      // 到达目标的精度（±2°）
```

---

## 🎮 完整按键参考（v2.1 恢复 v1.0 映射）

| 分类 | 按键 | 功能 | 说明 |
|------|------|------|------|
| **底盘** | 左摇杆↑↓ | 前后移动 | 向上前进、向下后退 |
| | 左摇杆← → | 左右平移 | 平行移动 |
| | 右摇杆← → | 原地旋转 | 灵敏度 80% |
| | 右肩键 | 自动转向 | 自动向右转45° |
| **拾取** | A 键 | 拾取进 | 启动拾取电机（独立） |
| | B 键 | 拾取退 | 拾取反向（独立） |
| **装填** | LT 键 | 装填进 | 启动装填电机（独立） |
| | LB 键 | 装填反 | 装填反向（独立） |
| **发射档位** | D-Pad → | 超远档 | 1800 RPM，精度 ±200 |
| | D-Pad ← | 腰部档 | 1400 RPM，精度 ±200 |
| | D-Pad ↓ | 底部档 | 1200 RPM，精度 ±200 |
| | D-Pad ↑ | 顶点档 | 1650 RPM，精度 ±200 |
| **发射控制** | RT 键 | 发射/停止 | 转速达标时启动，再按停止（独立） |

---

## ⚡ v2.1 独立控制调试流程

> v2.1 最大优势：三个系统完全独立，可逐个调试

### 第一步：调试底盘

```
操作：左摇杆 + 右摇杆
检查项：
□ 左摇杆↑ → 机器人前进
□ 左摇杆↓ → 机器人后退
□ 左摇杆← → 机器人左平移
□ 左摇杆→ → 机器人右平移
□ 右摇杆← → 机器人逆时针旋转
□ 右摇杆→ → 机器人顺时针旋转
```

### 第二步：调试拾取（A/B）

```
操作：只按 A 和 B 键，不按其他任何键
检查项：
□ A 键 → 拾取电机正向旋转（吸入小球）
□ B 键 → 拾取电机反向旋转（推出小球）
□ 松开 → 拾取电机停止

注意：v2.1 中 A/B 只控制拾取，不影响装填
```

### 第三步：调试装填（LT/LB）

```
操作：只按 LT 和 LB 键，不按其他任何键
检查项：
□ LT 键 → 装填电机正向旋转
□ LB 键 → 装填电机反向旋转
□ 松开 → 装填电机停止

注意：v2.1 中 LT/LB 只控制装填，不影响拾取
```

### 第四步：调试发射档位（D-Pad）

```
操作：按 D-Pad 的 ←↑→↓ 设置档位，观察遥测
检查项：
□ D-Pad → → 遥测显示 1800 RPM
□ D-Pad ← → 遥测显示 1400 RPM
□ D-Pad ↓ → 遥测显示 1200 RPM
□ D-Pad ↑ → 遥测显示 1650 RPM

等待 3 秒，确认转速稳定并显示"达标"
```

### 第五步：调试发射（RT）

```
操作：先按 D-Pad 设置档位，等转速达标后按 RT
检查项：
□ 转速达标 + 按 RT → 发射启动
□ 发射中 + 按 RT → 发射停止
□ 拾取进行中 + 按 RT → 发射停止

注意：v2.1 发射完全独立，不受拾取/装填影响
```

### 第六步：集成测试

```
完整动作序列：
1. 使用摇杆移动机器人到适当位置
2. 按 B 键推出小球（清空拾取轴）
3. 按 A 键启动拾取
4. 按 D-Pad 设置发射档位
5. 按 LT 启动装填
6. 等待转速达标（看遥测）
7. 按 RT 启动发射
8. 发射完成后按 RT 停止
```

---

## 🔧 常见问题和解决方案（v2.1）

### Q1: 拾取和装填无法同时工作

**v1.0 问题，v2.1 已解决！**

在 v2.1 中，拾取、装填、发射三个系统完全独立：
- A/B 只控制拾取
- LT/LB 只控制装填
- RT 只控制发射

这意味着你可以：
```
同时按下 A + LT → 拾取进 + 装填进
同时按下 B + LB → 拾取反 + 装填反
同时按下 A + RT → 拾取进 + 发射（如果达标）
```

### Q2: 转速档位达不到目标

**症状**：
- 显示的当前转速总是低于目标转速
- 即使长时间旋转也达不到目标

**解决方案**：
1. 检查电池电压是否足够（应该 > 11V）
2. 检查发射电机是否卡住
3. 增加 PIDF 中的 F 值（前馈）：从 16 改为 18 或 20
4. 检查精度范围是否设置得太严格

### Q3: 转速精度范围设置错误

**问题**：
- 转速明明达到了，但还是显示"未达标"

**解决方案**：
```java
// 查看遥测显示的当前转速波动范围
// 假设显示：1200 ± 40 RPM

// 在 v2.1 中，所有档位统一为 ±200 RPM
SHOOTER_RPM_ERROR_RANGE = 200;

// 如果仍然显示"未达标"，增加到 250
SHOOTER_RPM_ERROR_RANGE = 250;
```

### Q4: IMU 读数异常或自动转向不工作

**症状**：
- 显示的航向角度不合理
- 按右肩键没反应

**解决方案**：
1. 检查 IMU 是否已连接到控制器
2. 上传程序后，让机器人平放静止 2-3 秒，等待初始化
3. 在代码中调用 `navigation.initialize()` 重新初始化
4. 检查 IMU 名称是否正确（默认 "imu"）

### Q5: 编译出错 - 文件名错误

**错误信息**：`cannot find symbol: class TeleOp_2_0_0`

**解决方案**：
确认你修改的是 v2.1 的文件：
```
✗ 错误 → 修改了 TeleOp_All_2_0_0.java
✓ 正确 → 修改了 TeleOp_All_2_1.java
```

### Q6: 精度太严格导致永远无法"达标"

**问题**：转速在 1195-1205 RPM 波动，设置的精度 ±200 仍然显示"未达标"

**原因**：浮点数比较问题

**解决方案**：增加精度范围到 ±250 或更大

---

## 📊 遥测显示说明

### 遥测输出示例（v2.1）

```
========== TeleOp v2.1 ==========
运行时间: 0:00:15.234
状态: 运行中

--- 发射系统 ---
目标转速: 1900 RPM
当前转速: 1895.5 RPM
转速达标: ✓ 是
发射状态: 发射中

--- 导航系统 ---
当前航向: 43.2°
目标航向: 45.0°
自动转向: 进行中
```

### 关键指标解读

| 指标 | 说明 | 正常范围 |
|------|------|--------|
| 目标转速 | 当前选择的转速档位 | 1650-3200 |
| 当前转速 | 实时读取的转速 | 接近目标 ±精度范围 |
| 转速达标 | 是否在精度范围内 | ✓ 是（当前RPM在范围内） |
| 当前航向 | IMU 读取的方向 | -180 到 180° |
| 自动转向 | 是否正在自动转向 | 关闭或进行中 |

---

## 🚀 部署流程详解

### 第一步：准备硬件

```
1. 检查所有电机连接
   □ 4 个底盘电机（lf, rf, lb, rb）
   □ 拾取电机（intake）
   □ 装填电机（load）
   □ 2 个发射电机（s1, s2）
   □ IMU 传感器（imu）

2. 检查编码器
   □ 2 个发射电机都有编码器
   □ 编码器连接正确
```

### 第二步：修改配置

```
1. 打开程序文件
   - 单文件版：TeleOp_All_2_0_0.java
   - 多文件版：RobotConstants_2_0.java

2. 修改硬件名称
   - 根据你的硬件配置修改 9 个硬件名称

3. 修改参数（可选）
   - 转速档位
   - 精度范围
   - IMU PID 参数
```

### 第三步：编译上传

```
1. 在 Android Studio 中编译
2. 连接 USB 上传到控制器
3. 程序会自动初始化所有硬件
```

### 第四步：IMU 校准

```
1. 上传程序后等待 1 秒
2. 让机器人保持平放状态
3. 等待 2-3 秒以完成 IMU 校准
4. 遥测会显示当前航向（应该接近 0°）
```

### 第五步：测试功能

```
按功能逐个测试：

基础功能：
□ 摇杆能控制底盘
□ 底盘能前后移动、左右平移、旋转

拾取系统：
□ A 键启动拾取
□ B 键反向拾取
□ X 键停止

发射系统：
□ D-Pad 能切换档位
□ 遥测显示转速上升
□ 转速达标时 Y 键能启动发射

IMU 系统：
□ 遥测显示当前航向（-180 到 180°）
□ 右肩键自动转向
□ 转向停止时角度接近 45°
```

### 第六步：调优参数

```
1. 根据实际情况调整转速档位
2. 根据精度要求调整精度范围
3. 根据转向效果调整 PID 参数
4. 反复测试直到满意
```

---

## 💡 使用建议

### 转速档位选择建议

```
比赛场景 | 推荐档位 | RPM | 说明
---------|---------|-----|------
远距投篮  | 超远档  | 3200 | 最远距离，要求精度
中距投篮  | 顶点档  | 2400 | 平衡距离和精度
近距投篮  | 腰部档  | 1900 | 最稳定的档位
极近距离  | 底部档  | 1650 | 柔和发射
```

### PID 参数调整流程

```
1. 首先观察转向速度
   - 太慢：增加 P 值
   - 太快或超调：增加 D 值

2. 然后观察精度
   - 不准确：减小 HEADING_THRESHOLD
   - 易抖动：增加 D 值

3. 最后微调
   - 如果还有问题，调整 I 值（通常为 0）
```

---

## 📈 性能优化建议

### 1. 发射稳定性优化

```java
// 增加 PID 的 D 值以减少波动
SHOOTER_PIDF_D = 100;  // 原来是 80

// 增加 F 值以加快转速响应
SHOOTER_PIDF_F = 16;   // 原来是 14
```

### 2. 自动转向精准度优化

```java
// 减小角度精度要求
AUTO_TURN_HEADING_THRESHOLD = 1.0;  // 从 2.0 改为 1.0

// 增加 D 值防止超调
AUTO_TURN_D_GAIN = 0.01;           // 从 0.005 改为 0.01
```

### 3. 低延迟优化

```java
// 使用单文件版本而不是多文件版本
// 编译时间从 3-5 秒减少到 2-3 秒
```

---

## ✅ 部署前最终检查

```
□ 硬件
  □ 所有电机已连接
  □ IMU 已连接
  □ 编码器正常

□ 软件
  □ 硬件名称已修改
  □ 代码能编译通过
  □ 没有 Java 编译错误

□ 初始化
  □ 程序启动后 IMU 已校准
  □ 遥测显示初始化完成

□ 功能
  □ 所有功能都能正常工作
  □ 参数已根据实际调整
  □ 性能达到预期

准备完毕，可以上赛场！🚀
```

---

📝 **最后提醒**：
- 保存每次参数修改
- 记录哪些参数工作良好
- 为不同场地准备不同的参数配置
- 竞赛前充足的时间进行测试和调优

